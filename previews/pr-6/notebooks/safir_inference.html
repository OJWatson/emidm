
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Bayesian Inference for Time-Varying R(t) with the SAFIR Model &#8212; emidm  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
  
  <!-- So that users can add custom icons -->
  <script src="../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/safir_inference';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Training Surrogates" href="surrogate.html" />
    <link rel="prev" title="Bayesian Inference with Differentiable Models" href="bayesian_inference.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
  
    <p class="title logo__title">emidm  documentation</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../user_guide.html">
    User Guide
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../tutorials.html">
    Tutorials
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../api.html">
    API Reference
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../development.html">
    Development Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../slides.html">
    Slides
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/OJWatson/emidm" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../user_guide.html">
    User Guide
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../tutorials.html">
    Tutorials
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../api.html">
    API Reference
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../development.html">
    Development Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../slides.html">
    Slides
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/OJWatson/emidm" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="calibration.html">Calibrating a Differentiable SIR Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="bayesian_inference.html">Bayesian Inference with Differentiable Models</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Bayesian Inference for Time-Varying R(t) with the SAFIR Model</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="surrogate.html">Training Surrogates</a></li>
<li class="toctree-l1"><a class="reference internal" href="AIMS_surrogate_notebook.html">Training Deep Learning Surrogates for Infectious Disease Modelling</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="intro.html">Introduction to Jupyter and Colab Notebooks</a></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../tutorials.html" class="nav-link">Tutorials</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">Bayesian Inference for Time-Varying R(t) with the SAFIR Model</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="bayesian-inference-for-time-varying-r-t-with-the-safir-model">
<h1>Bayesian Inference for Time-Varying R(t) with the SAFIR Model<a class="headerlink" href="#bayesian-inference-for-time-varying-r-t-with-the-safir-model" title="Link to this heading">#</a></h1>
<p><a class="reference external" href="https://colab.research.google.com/github/OJWatson/emidm/blob/main/docs/notebooks/safir_inference.ipynb"><img alt="Open In Colab" src="https://colab.research.google.com/assets/colab-badge.svg" /></a></p>
<p>This notebook demonstrates how to:</p>
<ol class="arabic simple">
<li><p>Set up a realistic age-structured SAFIR model with UK demographics</p></li>
<li><p>Simulate a COVID-19-like epidemic with time-varying R(t) matching the UK 2020 pattern</p></li>
<li><p>Use Bayesian inference to estimate the time-varying R(t) from death data</p></li>
</ol>
<p>The key feature is that <strong>emidm</strong>â€™s differentiable SAFIR model enables gradient-based inference, making it much faster than derivative-free methods.</p>
<hr class="docutils" />
<p><strong>Authors:</strong> Oliver (OJ) Watson. 2025. MIT Licence 2.0.
<strong>Affiliation:</strong> MRC-GIDA, School of Public Health, Imperial College London</p>
<section id="setup-and-installation">
<h2>1. Setup and Installation<a class="headerlink" href="#setup-and-installation" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Install emidm with JAX and Bayesian inference support (uncomment if needed)</span>
<span class="c1"># !pip install &quot;emidm[jax,bayes] @ git+https://github.com/OJWatson/emidm.git&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="c1"># JAX imports</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jax</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jax.numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">jnp</span>

<span class="c1"># emidm imports</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">emidm</span><span class="w"> </span><span class="kn">import</span> <span class="n">run_diff_safir_simulation</span><span class="p">,</span> <span class="n">make_diff_safir_model</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">emidm.optim</span><span class="w"> </span><span class="kn">import</span> <span class="n">optimize_params</span>

<span class="c1"># Set random seed for reproducibility</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;JAX version: </span><span class="si">{</span><span class="n">jax</span><span class="o">.</span><span class="n">__version__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Devices: </span><span class="si">{</span><span class="n">jax</span><span class="o">.</span><span class="n">devices</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Check if blackjax is available</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">blackjax</span>
    <span class="n">HAS_BLACKJAX</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;BlackJAX available - will run MCMC&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">HAS_BLACKJAX</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;BlackJAX not available - install with: pip install blackjax&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>JAX version: 0.4.30
Devices: [cuda(id=0)]
BlackJAX available - will run MCMC
</pre></div>
</div>
</div>
</div>
</section>
<section id="uk-demographics-and-contact-matrix">
<h2>2. UK Demographics and Contact Matrix<a class="headerlink" href="#uk-demographics-and-contact-matrix" title="Link to this heading">#</a></h2>
<p>We use a simplified 8 age-group structure based on UK demographics:</p>
<ul class="simple">
<li><p>0-9, 10-19, 20-29, 30-39, 40-49, 50-59, 60-69, 70+</p></li>
</ul>
<p>The contact matrix is derived from Prem et al. (2017, 2021) and represents average daily contacts between age groups in the UK.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># UK population by age group (in thousands, 2020 estimates)</span>
<span class="c1"># Age groups: 0-9, 10-19, 20-29, 30-39, 40-49, 50-59, 60-69, 70+</span>
<span class="n">uk_population</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
    <span class="mi">8000</span><span class="p">,</span>   <span class="c1"># 0-9</span>
    <span class="mi">7500</span><span class="p">,</span>   <span class="c1"># 10-19</span>
    <span class="mi">8500</span><span class="p">,</span>   <span class="c1"># 20-29</span>
    <span class="mi">8800</span><span class="p">,</span>   <span class="c1"># 30-39</span>
    <span class="mi">8200</span><span class="p">,</span>   <span class="c1"># 40-49</span>
    <span class="mi">9000</span><span class="p">,</span>   <span class="c1"># 50-59</span>
    <span class="mi">7200</span><span class="p">,</span>   <span class="c1"># 60-69</span>
    <span class="mi">9800</span><span class="p">,</span>   <span class="c1"># 70+</span>
<span class="p">])</span> <span class="o">*</span> <span class="mi">1000</span>  <span class="c1"># Convert to actual population</span>

<span class="c1"># For computational efficiency, we scale down the population</span>
<span class="c1"># while maintaining the age structure</span>
<span class="n">scale_factor</span> <span class="o">=</span> <span class="mi">1000</span>  <span class="c1"># 1:1000 scaling for computational efficiency</span>
<span class="n">population</span> <span class="o">=</span> <span class="p">(</span><span class="n">uk_population</span> <span class="o">/</span> <span class="n">scale_factor</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total population (scaled): </span><span class="si">{</span><span class="n">population</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Population by age group: </span><span class="si">{</span><span class="n">population</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Total population (scaled): 67,000
Population by age group: [8000 7500 8500 8800 8200 9000 7200 9800]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># UK contact matrix (average daily contacts between age groups)</span>
<span class="c1"># Based on Prem et al. (2017) - simplified to 8 age groups</span>
<span class="n">uk_contact_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
    <span class="c1"># 0-9   10-19  20-29  30-39  40-49  50-59  60-69  70+</span>
    <span class="p">[</span><span class="mf">4.50</span><span class="p">,</span>  <span class="mf">1.20</span><span class="p">,</span>  <span class="mf">0.80</span><span class="p">,</span>  <span class="mf">1.50</span><span class="p">,</span>  <span class="mf">1.20</span><span class="p">,</span>  <span class="mf">0.60</span><span class="p">,</span>  <span class="mf">0.40</span><span class="p">,</span>  <span class="mf">0.30</span><span class="p">],</span>  <span class="c1"># 0-9</span>
    <span class="p">[</span><span class="mf">1.20</span><span class="p">,</span>  <span class="mf">8.50</span><span class="p">,</span>  <span class="mf">2.00</span><span class="p">,</span>  <span class="mf">1.00</span><span class="p">,</span>  <span class="mf">1.50</span><span class="p">,</span>  <span class="mf">1.00</span><span class="p">,</span>  <span class="mf">0.50</span><span class="p">,</span>  <span class="mf">0.30</span><span class="p">],</span>  <span class="c1"># 10-19</span>
    <span class="p">[</span><span class="mf">0.80</span><span class="p">,</span>  <span class="mf">2.00</span><span class="p">,</span>  <span class="mf">5.50</span><span class="p">,</span>  <span class="mf">2.50</span><span class="p">,</span>  <span class="mf">1.50</span><span class="p">,</span>  <span class="mf">1.00</span><span class="p">,</span>  <span class="mf">0.60</span><span class="p">,</span>  <span class="mf">0.40</span><span class="p">],</span>  <span class="c1"># 20-29</span>
    <span class="p">[</span><span class="mf">1.50</span><span class="p">,</span>  <span class="mf">1.00</span><span class="p">,</span>  <span class="mf">2.50</span><span class="p">,</span>  <span class="mf">4.00</span><span class="p">,</span>  <span class="mf">2.00</span><span class="p">,</span>  <span class="mf">1.20</span><span class="p">,</span>  <span class="mf">0.70</span><span class="p">,</span>  <span class="mf">0.50</span><span class="p">],</span>  <span class="c1"># 30-39</span>
    <span class="p">[</span><span class="mf">1.20</span><span class="p">,</span>  <span class="mf">1.50</span><span class="p">,</span>  <span class="mf">1.50</span><span class="p">,</span>  <span class="mf">2.00</span><span class="p">,</span>  <span class="mf">3.50</span><span class="p">,</span>  <span class="mf">1.80</span><span class="p">,</span>  <span class="mf">0.90</span><span class="p">,</span>  <span class="mf">0.60</span><span class="p">],</span>  <span class="c1"># 40-49</span>
    <span class="p">[</span><span class="mf">0.60</span><span class="p">,</span>  <span class="mf">1.00</span><span class="p">,</span>  <span class="mf">1.00</span><span class="p">,</span>  <span class="mf">1.20</span><span class="p">,</span>  <span class="mf">1.80</span><span class="p">,</span>  <span class="mf">3.00</span><span class="p">,</span>  <span class="mf">1.50</span><span class="p">,</span>  <span class="mf">0.80</span><span class="p">],</span>  <span class="c1"># 50-59</span>
    <span class="p">[</span><span class="mf">0.40</span><span class="p">,</span>  <span class="mf">0.50</span><span class="p">,</span>  <span class="mf">0.60</span><span class="p">,</span>  <span class="mf">0.70</span><span class="p">,</span>  <span class="mf">0.90</span><span class="p">,</span>  <span class="mf">1.50</span><span class="p">,</span>  <span class="mf">2.50</span><span class="p">,</span>  <span class="mf">1.20</span><span class="p">],</span>  <span class="c1"># 60-69</span>
    <span class="p">[</span><span class="mf">0.30</span><span class="p">,</span>  <span class="mf">0.30</span><span class="p">,</span>  <span class="mf">0.40</span><span class="p">,</span>  <span class="mf">0.50</span><span class="p">,</span>  <span class="mf">0.60</span><span class="p">,</span>  <span class="mf">0.80</span><span class="p">,</span>  <span class="mf">1.20</span><span class="p">,</span>  <span class="mf">2.00</span><span class="p">],</span>  <span class="c1"># 70+</span>
<span class="p">])</span>

<span class="c1"># Make the matrix symmetric (reciprocal contacts)</span>
<span class="n">contact_matrix</span> <span class="o">=</span> <span class="p">(</span><span class="n">uk_contact_matrix</span> <span class="o">+</span> <span class="n">uk_contact_matrix</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Contact matrix shape:&quot;</span><span class="p">,</span> <span class="n">contact_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Contact matrix:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">contact_matrix</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Contact matrix shape: (8, 8)
Contact matrix:
[[4.5 1.2 0.8 1.5 1.2 0.6 0.4 0.3]
 [1.2 8.5 2.  1.  1.5 1.  0.5 0.3]
 [0.8 2.  5.5 2.5 1.5 1.  0.6 0.4]
 [1.5 1.  2.5 4.  2.  1.2 0.7 0.5]
 [1.2 1.5 1.5 2.  3.5 1.8 0.9 0.6]
 [0.6 1.  1.  1.2 1.8 3.  1.5 0.8]
 [0.4 0.5 0.6 0.7 0.9 1.5 2.5 1.2]
 [0.3 0.3 0.4 0.5 0.6 0.8 1.2 2. ]]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Visualize the contact matrix</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">contact_matrix</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;YlOrRd&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
<span class="n">age_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;0-9&#39;</span><span class="p">,</span> <span class="s1">&#39;10-19&#39;</span><span class="p">,</span> <span class="s1">&#39;20-29&#39;</span><span class="p">,</span> <span class="s1">&#39;30-39&#39;</span><span class="p">,</span> <span class="s1">&#39;40-49&#39;</span><span class="p">,</span> <span class="s1">&#39;50-59&#39;</span><span class="p">,</span> <span class="s1">&#39;60-69&#39;</span><span class="p">,</span> <span class="s1">&#39;70+&#39;</span><span class="p">]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">age_labels</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">age_labels</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Age of contact&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Age of individual&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;UK Contact Matrix (daily contacts)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Average daily contacts&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/6cc10d7e41f0bbd0ef41f48f47fdba6def5a0570fc94394fbe7a4620831f9fa7.png" src="../_images/6cc10d7e41f0bbd0ef41f48f47fdba6def5a0570fc94394fbe7a4620831f9fa7.png" />
</div>
</div>
</section>
<section id="simulating-the-uk-2020-epidemic">
<h2>3. Simulating the UK 2020 Epidemic<a class="headerlink" href="#simulating-the-uk-2020-epidemic" title="Link to this heading">#</a></h2>
<p>We create a time-varying R(t) that roughly matches the UK epidemic pattern in 2020:</p>
<ol class="arabic simple">
<li><p><strong>March</strong>: Initial exponential growth (R ~ 2.5-3.0) - fast increase</p></li>
<li><p><strong>April-June</strong>: First lockdown - slow decrease to R ~ 0.7-0.8</p></li>
<li><p><strong>July-September</strong>: Gradual reopening - slow increase to R ~ 1.2</p></li>
<li><p><strong>October-November</strong>: Second lockdown - short decrease</p></li>
<li><p><strong>July-August</strong>: Summer reopening continues</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">create_uk_2020_rt</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="mi">300</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a time-varying R(t) mimicking UK 2020 epidemic.</span>
<span class="sd">    </span>
<span class="sd">    Pattern:</span>
<span class="sd">    - Fast increase (March)</span>
<span class="sd">    - Slow decrease (April-June lockdown)</span>
<span class="sd">    - Slow increase (July-September reopening)</span>
<span class="sd">    - Short decrease (October-November second lockdown)</span>
<span class="sd">    - Fast increase (December Alpha variant)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">R_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">T</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">T</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">:</span>  <span class="c1"># Early March: fast exponential growth</span>
            <span class="n">R_t</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.5</span> <span class="o">+</span> <span class="n">t</span> <span class="o">*</span> <span class="mf">0.03</span>  <span class="c1"># 2.5 -&gt; 2.95</span>
        <span class="k">elif</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="mi">25</span><span class="p">:</span>  <span class="c1"># Mid-March: peak before lockdown</span>
            <span class="n">R_t</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.95</span>
        <span class="k">elif</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="mi">90</span><span class="p">:</span>  <span class="c1"># Late March - May: slow decrease (lockdown)</span>
            <span class="n">progress</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="mi">25</span><span class="p">)</span> <span class="o">/</span> <span class="mi">65</span>
            <span class="n">R_t</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.95</span> <span class="o">-</span> <span class="n">progress</span> <span class="o">*</span> <span class="mf">2.15</span>  <span class="c1"># 2.95 -&gt; 0.8</span>
        <span class="k">elif</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="mi">180</span><span class="p">:</span>  <span class="c1"># June - August: slow increase (reopening)</span>
            <span class="n">progress</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="mi">90</span><span class="p">)</span> <span class="o">/</span> <span class="mi">90</span>
            <span class="n">R_t</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.8</span> <span class="o">+</span> <span class="n">progress</span> <span class="o">*</span> <span class="mf">0.5</span>  <span class="c1"># 0.8 -&gt; 1.3</span>
        <span class="k">elif</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="mi">240</span><span class="p">:</span>  <span class="c1"># September - October: continued slow increase</span>
            <span class="n">progress</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="mi">180</span><span class="p">)</span> <span class="o">/</span> <span class="mi">60</span>
            <span class="n">R_t</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.3</span> <span class="o">+</span> <span class="n">progress</span> <span class="o">*</span> <span class="mf">0.2</span>  <span class="c1"># 1.3 -&gt; 1.5</span>
        <span class="k">elif</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="mi">270</span><span class="p">:</span>  <span class="c1"># November: short decrease (second lockdown)</span>
            <span class="n">progress</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="mi">240</span><span class="p">)</span> <span class="o">/</span> <span class="mi">30</span>
            <span class="n">R_t</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.5</span> <span class="o">-</span> <span class="n">progress</span> <span class="o">*</span> <span class="mf">0.6</span>  <span class="c1"># 1.5 -&gt; 0.9</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># December: fast increase (Alpha variant)</span>
            <span class="n">progress</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="mi">270</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">T</span> <span class="o">-</span> <span class="mi">270</span><span class="p">)</span> <span class="k">if</span> <span class="n">T</span> <span class="o">&gt;</span> <span class="mi">270</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">R_t</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.9</span> <span class="o">+</span> <span class="n">progress</span> <span class="o">*</span> <span class="mf">0.8</span>  <span class="c1"># 0.9 -&gt; 1.7</span>
    
    <span class="k">return</span> <span class="n">R_t</span>

<span class="c1"># Create R(t) for full year (March - December 2020)</span>
<span class="n">T</span> <span class="o">=</span> <span class="mi">150</span>  <span class="c1"># ~5 months (March - July)</span>
<span class="n">true_R_t</span> <span class="o">=</span> <span class="n">create_uk_2020_rt</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>

<span class="c1"># Month labels for plotting</span>
<span class="n">months</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Mar&#39;</span><span class="p">,</span> <span class="s1">&#39;Apr&#39;</span><span class="p">,</span> <span class="s1">&#39;May&#39;</span><span class="p">,</span> <span class="s1">&#39;Jun&#39;</span><span class="p">,</span> <span class="s1">&#39;Jul&#39;</span><span class="p">,</span> <span class="s1">&#39;Aug&#39;</span><span class="p">]</span>
<span class="n">month_days</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mi">92</span><span class="p">,</span> <span class="mi">122</span><span class="p">,</span> <span class="mi">153</span><span class="p">]</span>

<span class="c1"># Plot the true R(t)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">days</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">T</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">days</span><span class="p">,</span> <span class="n">true_R_t</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;R=1 threshold&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">days</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">true_R_t</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">true_R_t</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;R &gt; 1 (growing)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">days</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">true_R_t</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">true_R_t</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;R &lt;= 1 (declining)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Days since March 1, 2020&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;R(t)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;True Time-Varying Reproduction Number (UK 2020 Pattern)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">month_days</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">months</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/4a0b027ca0b779318b144179b32d46ead3af72404a911968efdf1081cbc1bc2f.png" src="../_images/4a0b027ca0b779318b144179b32d46ead3af72404a911968efdf1081cbc1bc2f.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run the SAFIR model with time-varying R(t)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">emidm.diff</span><span class="w"> </span><span class="kn">import</span> <span class="n">DiffConfig</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running SAFIR simulation...&quot;</span><span class="p">)</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">run_diff_safir_simulation</span><span class="p">(</span>
    <span class="n">population</span><span class="o">=</span><span class="n">population</span><span class="p">,</span>
    <span class="n">contact_matrix</span><span class="o">=</span><span class="n">contact_matrix</span><span class="p">,</span>
    <span class="n">R0</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span>          <span class="c1"># Base R0 for beta calibration</span>
    <span class="n">R_t</span><span class="o">=</span><span class="n">true_R_t</span><span class="p">,</span>    <span class="c1"># Time-varying R(t)</span>
    <span class="n">T</span><span class="o">=</span><span class="n">T</span><span class="p">,</span>
    <span class="n">dt</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span>         <span class="c1"># Sub-daily timestep</span>
    <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
    <span class="n">config</span><span class="o">=</span><span class="n">DiffConfig</span><span class="p">(</span><span class="n">tau</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">hard</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">I0</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>      <span class="c1"># Initial infections</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Simulation complete. Total deaths: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Running SAFIR simulation...
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-14 21:29:47.416727: W external/xla/xla/service/gpu/nvptx_compiler.cc:765] The NVIDIA driver&#39;s CUDA version is 12.4 which is older than the ptxas CUDA version (12.9.86). Because the driver is older than the ptxas version, XLA is disabling parallel compilation, which may slow down compilation. You should update your NVIDIA driver or use the NVIDIA-provided CUDA forward compatibility packages.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Simulation complete. Total deaths: 725
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot the epidemic trajectory</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">])</span>

<span class="c1"># Infections</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">],</span> <span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Infectious (I)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Active Infections&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>

<span class="c1"># Deaths (cumulative)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">],</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Cumulative Deaths (D)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Cumulative Deaths&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>

<span class="c1"># Daily deaths (what we&#39;ll fit to)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">daily_deaths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">]),</span> <span class="n">prepend</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">daily_deaths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">daily_deaths</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># Ensure non-negative</span>
<span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">daily_deaths</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Days&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Daily Deaths&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Daily Deaths (Observed Data)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>

<span class="c1"># R(t) for reference</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">true_R_t</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Days&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;R(t)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;True R(t)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">)</span>

<span class="c1"># Add month labels to all plots</span>
<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="o">.</span><span class="n">flat</span><span class="p">:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">month_days</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">months</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/1cec44a91fd2687f234767be5eb001b10ef025b52b4c3f01e62cfbd1df9f78ee.png" src="../_images/1cec44a91fd2687f234767be5eb001b10ef025b52b4c3f01e62cfbd1df9f78ee.png" />
</div>
</div>
</section>
<section id="bayesian-inference-setup">
<h2>4. Bayesian Inference Setup<a class="headerlink" href="#bayesian-inference-setup" title="Link to this heading">#</a></h2>
<p>We estimate R(t) using a <strong>piecewise constant</strong> parameterization with 2-week intervals. This gives us:</p>
<ul class="simple">
<li><p>~22 R(t) values to estimate for 300 days</p></li>
<li><p>A random walk prior to encourage smoothness</p></li>
</ul>
<section id="model-structure">
<h3>Model Structure<a class="headerlink" href="#model-structure" title="Link to this heading">#</a></h3>
<p><strong>Likelihood:</strong> We use a Poisson likelihood for death counts:</p>
<p>$$D_t \sim \text{Poisson}(\hat{D}<em>t(R</em>{1:K}))$$</p>
<p>where $\hat{D}_t$ is the predicted deaths from the SAFIR model.</p>
<p><strong>Prior (Random Walk):</strong> We place a random walk prior on log(R) to encourage smoothness:</p>
<p>$$\log(R_1) \sim \mathcal{N}(\log(2.5), 0.5^2)$$</p>
<p>$$\log(R_k) - \log(R_{k-1}) \sim \mathcal{N}(0, \sigma_{RW}^2)$$</p>
<p>The random walk prior encourages smoothness while allowing flexibility.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Store the &quot;observed&quot; daily deaths</span>
<span class="n">observed_deaths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">daily_deaths</span><span class="p">)</span>

<span class="c1"># Define the inference window (2-week intervals)</span>
<span class="n">interval_days</span> <span class="o">=</span> <span class="mi">14</span>
<span class="n">n_intervals</span> <span class="o">=</span> <span class="p">(</span><span class="n">T</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">interval_days</span> <span class="o">+</span> <span class="mi">1</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of R(t) parameters to estimate: </span><span class="si">{</span><span class="n">n_intervals</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Interval length: </span><span class="si">{</span><span class="n">interval_days</span><span class="si">}</span><span class="s2"> days&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Number of R(t) parameters to estimate: 11
Interval length: 14 days
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">expand_R_intervals</span><span class="p">(</span><span class="n">R_intervals</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">interval_days</span><span class="o">=</span><span class="mi">14</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Expand interval R values to daily R(t) array.&quot;&quot;&quot;</span>
    <span class="n">R_daily</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">T</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">R_val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">R_intervals</span><span class="p">):</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">interval_days</span>
        <span class="n">end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">((</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">interval_days</span><span class="p">,</span> <span class="n">T</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">R_daily</span> <span class="o">=</span> <span class="n">R_daily</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">R_val</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">R_daily</span>

<span class="c1"># Test the expansion</span>
<span class="n">test_R</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n_intervals</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.5</span>
<span class="n">test_expanded</span> <span class="o">=</span> <span class="n">expand_R_intervals</span><span class="p">(</span><span class="n">test_R</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">interval_days</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expanded R(t) shape: </span><span class="si">{</span><span class="n">test_expanded</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Expanded R(t) shape: (151,)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">log_prior</span><span class="p">(</span><span class="n">log_R_intervals</span><span class="p">,</span> <span class="n">sigma_rw</span><span class="o">=</span><span class="mf">0.3</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Random walk prior on log(R) values.&quot;&quot;&quot;</span>
    <span class="c1"># Prior on first R value: log(R_1) ~ N(log(2.5), 0.5^2)</span>
    <span class="n">log_prior_first</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">((</span><span class="n">log_R_intervals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.5</span><span class="p">))</span> <span class="o">/</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
    
    <span class="c1"># Random walk prior on increments</span>
    <span class="n">increments</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">log_R_intervals</span><span class="p">)</span>
    <span class="n">log_prior_rw</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">increments</span> <span class="o">/</span> <span class="n">sigma_rw</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    
    <span class="c1"># Soft constraint: R should be positive and reasonable (0.1 to 5)</span>
    <span class="n">R_intervals</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_R_intervals</span><span class="p">)</span>
    <span class="n">penalty</span> <span class="o">=</span> <span class="o">-</span><span class="mf">100.0</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">R_intervals</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
    <span class="n">penalty</span> <span class="o">+=</span> <span class="o">-</span><span class="mf">100.0</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">R_intervals</span> <span class="o">&gt;</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
    
    <span class="k">return</span> <span class="n">log_prior_first</span> <span class="o">+</span> <span class="n">log_prior_rw</span> <span class="o">+</span> <span class="n">penalty</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a pre-compiled model for efficient inference</span>
<span class="c1"># This pre-computes all static values once, making repeated calls much faster</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">emidm.diff</span><span class="w"> </span><span class="kn">import</span> <span class="n">DiffConfig</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Creating pre-compiled SAFIR model for inference...&quot;</span><span class="p">)</span>
<span class="n">safir_model</span> <span class="o">=</span> <span class="n">make_diff_safir_model</span><span class="p">(</span>
    <span class="n">population</span><span class="o">=</span><span class="n">population</span><span class="p">,</span>
    <span class="n">contact_matrix</span><span class="o">=</span><span class="n">contact_matrix</span><span class="p">,</span>
    <span class="n">R0</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span>
    <span class="n">T</span><span class="o">=</span><span class="n">T</span><span class="p">,</span>
    <span class="n">dt</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>       <span class="c1"># Coarser timestep for faster inference</span>
    <span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">config</span><span class="o">=</span><span class="n">DiffConfig</span><span class="p">(</span><span class="n">tau</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">hard</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>  <span class="c1"># Soft sampling for better gradients</span>
    <span class="n">I0</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Model created!&quot;</span><span class="p">)</span>

<span class="c1"># Store observed deaths as JAX array (avoid repeated conversion)</span>
<span class="n">obs_deaths_jnp</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">observed_deaths</span><span class="p">)</span>

<span class="c1"># JIT-compiled log-likelihood function</span>
<span class="nd">@jax</span><span class="o">.</span><span class="n">jit</span>
<span class="k">def</span><span class="w"> </span><span class="nf">log_likelihood</span><span class="p">(</span><span class="n">log_R_intervals</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute log-likelihood using the pre-compiled SAFIR model.&quot;&quot;&quot;</span>
    <span class="n">R_intervals</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_R_intervals</span><span class="p">)</span>
    <span class="n">R_t</span> <span class="o">=</span> <span class="n">expand_R_intervals</span><span class="p">(</span><span class="n">R_intervals</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">interval_days</span><span class="p">)</span>
    
    <span class="c1"># Use the pre-compiled model (fast, differentiable)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">safir_model</span><span class="p">(</span><span class="n">R_t</span><span class="p">)</span>
    
    <span class="n">predicted_D</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">]</span>
    <span class="n">predicted_daily</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">predicted_D</span><span class="p">,</span> <span class="n">prepend</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">predicted_daily</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">predicted_daily</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
    
    <span class="c1"># Poisson log-likelihood</span>
    <span class="n">log_lik</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">obs_deaths_jnp</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">predicted_daily</span> <span class="o">+</span> <span class="mf">1e-8</span><span class="p">)</span> <span class="o">-</span> <span class="n">predicted_daily</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">log_lik</span>

<span class="c1"># JIT-compiled log-posterior function</span>
<span class="nd">@jax</span><span class="o">.</span><span class="n">jit</span>
<span class="k">def</span><span class="w"> </span><span class="nf">log_posterior</span><span class="p">(</span><span class="n">log_R_intervals</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute log-posterior = log-likelihood + log-prior.&quot;&quot;&quot;</span>
    <span class="n">ll</span> <span class="o">=</span> <span class="n">log_likelihood</span><span class="p">(</span><span class="n">log_R_intervals</span><span class="p">)</span>
    <span class="n">lp</span> <span class="o">=</span> <span class="n">log_prior</span><span class="p">(</span><span class="n">log_R_intervals</span><span class="p">,</span> <span class="n">sigma_rw</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ll</span> <span class="o">+</span> <span class="n">lp</span>

<span class="c1"># Warm up JIT compilation (one-time cost)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Compiling inference functions...&quot;</span><span class="p">)</span>
<span class="n">init_log_R</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n_intervals</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.5</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">log_posterior</span><span class="p">(</span><span class="n">init_log_R</span><span class="p">)</span><span class="o">.</span><span class="n">block_until_ready</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done! Inference functions are JIT-compiled.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Creating pre-compiled SAFIR model for inference...
Model created!
Compiling inference functions...
Done! Inference functions are JIT-compiled.
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="maximum-a-posteriori-map-estimation">
<h2>5. Maximum A Posteriori (MAP) Estimation<a class="headerlink" href="#maximum-a-posteriori-map-estimation" title="Link to this heading">#</a></h2>
<p>Before running full MCMC, we find the MAP estimate using gradient descent. This gives us a good starting point and validates that our differentiable model is working.</p>
<p>The key advantage of <strong>emidm</strong>â€™s differentiable SAFIR model is that we can compute gradients through the entire simulation, enabling fast gradient-based optimization.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define negative log-posterior for minimization (JIT-compiled)</span>
<span class="nd">@jax</span><span class="o">.</span><span class="n">jit</span>
<span class="k">def</span><span class="w"> </span><span class="nf">neg_log_posterior</span><span class="p">(</span><span class="n">log_R_intervals</span><span class="p">):</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">log_posterior</span><span class="p">(</span><span class="n">log_R_intervals</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Finding MAP estimate...&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initial negative log-posterior: </span><span class="si">{</span><span class="n">neg_log_posterior</span><span class="p">(</span><span class="n">init_log_R</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Finding MAP estimate...
Initial negative log-posterior: -1101.42
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run optimization using emidm&#39;s optimize_params</span>
<span class="n">map_log_R</span><span class="p">,</span> <span class="n">history</span> <span class="o">=</span> <span class="n">optimize_params</span><span class="p">(</span>
    <span class="n">loss_fn</span><span class="o">=</span><span class="n">neg_log_posterior</span><span class="p">,</span>
    <span class="n">init_params</span><span class="o">=</span><span class="n">init_log_R</span><span class="p">,</span>
    <span class="n">n_steps</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span>
    <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">map_R</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">map_log_R</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final negative log-posterior: </span><span class="si">{</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MAP R(t) estimates:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">map_R</span><span class="p">):</span>
    <span class="n">start_day</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">interval_days</span>
    <span class="n">end_day</span> <span class="o">=</span> <span class="nb">min</span><span class="p">((</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">interval_days</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Interval </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> (days </span><span class="si">{</span><span class="n">start_day</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">end_day</span><span class="si">}</span><span class="s2">): R = </span><span class="si">{</span><span class="n">r</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Final negative log-posterior: -730.06
MAP R(t) estimates:
  Interval 1 (days 0-13): R = 1.11
  Interval 2 (days 14-27): R = 1.17
  Interval 3 (days 28-41): R = 2.27
  Interval 4 (days 42-55): R = 4.14
  Interval 5 (days 56-69): R = 2.77
  Interval 6 (days 70-83): R = 2.45
  Interval 7 (days 84-97): R = 2.44
  Interval 8 (days 98-111): R = 2.44
  Interval 9 (days 112-125): R = 2.44
  Interval 10 (days 126-139): R = 2.43
  Interval 11 (days 140-150): R = 2.43
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot optimization progress</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Iteration&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Negative Log-Posterior&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Optimization Progress&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="c1"># Plot true vs estimated R(t)</span>
<span class="n">map_R_expanded</span> <span class="o">=</span> <span class="n">expand_R_intervals</span><span class="p">(</span><span class="n">map_R</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">interval_days</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">T</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">true_R_t</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;True R(t)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">T</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">map_R_expanded</span><span class="p">),</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;MAP Estimate&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Days&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;R(t)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;True vs MAP Estimated R(t)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">month_days</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">months</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/c0a2b5cb7008d1c82cae1aaa58faa7a3331650bc6e66cd970f98420cecd4c3f1.png" src="../_images/c0a2b5cb7008d1c82cae1aaa58faa7a3331650bc6e66cd970f98420cecd4c3f1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compare predicted vs observed deaths with MAP estimate</span>
<span class="n">map_R_expanded</span> <span class="o">=</span> <span class="n">expand_R_intervals</span><span class="p">(</span><span class="n">map_R</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">interval_days</span><span class="p">)</span>

<span class="n">map_result</span> <span class="o">=</span> <span class="n">run_diff_safir_simulation</span><span class="p">(</span>
    <span class="n">population</span><span class="o">=</span><span class="n">population</span><span class="p">,</span>
    <span class="n">contact_matrix</span><span class="o">=</span><span class="n">contact_matrix</span><span class="p">,</span>
    <span class="n">R0</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span>
    <span class="n">R_t</span><span class="o">=</span><span class="n">map_R_expanded</span><span class="p">,</span>
    <span class="n">T</span><span class="o">=</span><span class="n">T</span><span class="p">,</span>
    <span class="n">dt</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span>
    <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
    <span class="n">config</span><span class="o">=</span><span class="n">DiffConfig</span><span class="p">(</span><span class="n">tau</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">hard</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">I0</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">map_daily_deaths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">map_result</span><span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">]),</span> <span class="n">prepend</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">map_daily_deaths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">map_daily_deaths</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">T</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">observed_deaths</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Observed&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">T</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">map_daily_deaths</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;MAP Prediction&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Days&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Daily Deaths&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Observed vs MAP Predicted Daily Deaths&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">month_days</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">months</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/8bef814d77df659d67ae746036eae2357616cdbfe8e0cdc87e1debefd0639a44.png" src="../_images/8bef814d77df659d67ae746036eae2357616cdbfe8e0cdc87e1debefd0639a44.png" />
</div>
</div>
</section>
<section id="full-bayesian-inference-with-mcmc">
<h2>6. Full Bayesian Inference with MCMC<a class="headerlink" href="#full-bayesian-inference-with-mcmc" title="Link to this heading">#</a></h2>
<p>Now we use the No-U-Turn Sampler (NUTS) via BlackJAX to get full posterior distributions for R(t).</p>
<p><strong>Note:</strong> MCMC is computationally intensive. Set <code class="docutils literal notranslate"><span class="pre">RUN_MCMC</span> <span class="pre">=</span> <span class="pre">True</span></code> to run full Bayesian inference.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># MCMC is computationally intensive - skip by default for faster notebook execution</span>
<span class="c1"># Set RUN_MCMC = True to run full Bayesian inference</span>
<span class="n">RUN_MCMC</span> <span class="o">=</span> <span class="kc">False</span>

<span class="k">if</span> <span class="n">HAS_BLACKJAX</span> <span class="ow">and</span> <span class="n">RUN_MCMC</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Setting up NUTS sampler...&quot;</span><span class="p">)</span>
    
    <span class="c1"># Use window adaptation for automatic tuning</span>
    <span class="n">warmup</span> <span class="o">=</span> <span class="n">blackjax</span><span class="o">.</span><span class="n">window_adaptation</span><span class="p">(</span><span class="n">blackjax</span><span class="o">.</span><span class="n">nuts</span><span class="p">,</span> <span class="n">log_posterior</span><span class="p">)</span>
    
    <span class="c1"># Run warmup to find good step size and mass matrix</span>
    <span class="n">rng_key</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
    <span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">params</span><span class="p">),</span> <span class="n">_</span> <span class="o">=</span> <span class="n">warmup</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">rng_key</span><span class="p">,</span> <span class="n">map_log_R</span><span class="p">,</span> <span class="n">num_steps</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    
    <span class="c1"># Create NUTS sampler with tuned parameters</span>
    <span class="n">nuts</span> <span class="o">=</span> <span class="n">blackjax</span><span class="o">.</span><span class="n">nuts</span><span class="p">(</span><span class="n">log_posterior</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">)</span>
    
    <span class="c1"># JIT compile the step function</span>
    <span class="n">step_fn</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">nuts</span><span class="o">.</span><span class="n">step</span><span class="p">)</span>
    
    <span class="c1"># Sampling loop using scan for efficiency</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">one_step</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">rng_key</span><span class="p">):</span>
        <span class="n">state</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">step_fn</span><span class="p">(</span><span class="n">rng_key</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">position</span>
    
    <span class="c1"># Run sampling</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running NUTS sampler (200 samples)...&quot;</span><span class="p">)</span>
    <span class="n">n_samples</span> <span class="o">=</span> <span class="mi">200</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">rng_key</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">)</span>
    
    <span class="n">final_state</span><span class="p">,</span> <span class="n">samples</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">one_step</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">keys</span><span class="p">)</span>
    <span class="n">samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
    
    <span class="c1"># Discard first 50 as burn-in</span>
    <span class="n">samples</span> <span class="o">=</span> <span class="n">samples</span><span class="p">[</span><span class="mi">50</span><span class="p">:]</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Collected </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span><span class="si">}</span><span class="s2"> samples (after burn-in)&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">HAS_BLACKJAX</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Skipping MCMC - BlackJAX not installed&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Skipping MCMC - set RUN_MCMC = True to run&quot;</span><span class="p">)</span>
    <span class="n">samples</span> <span class="o">=</span> <span class="kc">None</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Setting up NUTS sampler...
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-14 21:31:46.024283: W external/xla/xla/service/hlo_rematerialization.cc:3005] Can&#39;t reduce memory use below 1.22GiB (1309612445 bytes) by rematerialization; only reduced to 4.57GiB (4910851964 bytes), down from 4.57GiB (4910852069 bytes) originally
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">samples</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="c1"># Convert log(R) samples to R</span>
    <span class="n">R_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">samples</span><span class="p">))</span>
    
    <span class="c1"># Compute posterior statistics</span>
    <span class="n">R_mean</span> <span class="o">=</span> <span class="n">R_samples</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">R_std</span> <span class="o">=</span> <span class="n">R_samples</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">R_q05</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">R_samples</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">R_q95</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">R_samples</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Posterior R(t) estimates (mean +/- std):&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_intervals</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Interval </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">: R = </span><span class="si">{</span><span class="n">R_mean</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> +/- </span><span class="si">{</span><span class="n">R_std</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> (90% CI: [</span><span class="si">{</span><span class="n">R_q05</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">R_q95</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">])&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Final comparison plot</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="c1"># R(t) comparison</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">T</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">true_R_t</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;True R(t)&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">samples</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="c1"># Expand posterior samples to daily values</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">R_samples</span><span class="p">))):</span>  <span class="c1"># Plot subset of samples</span>
        <span class="n">R_expanded</span> <span class="o">=</span> <span class="n">expand_R_intervals</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">R_samples</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">T</span><span class="p">,</span> <span class="n">interval_days</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">T</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">R_expanded</span><span class="p">),</span> <span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s1">&#39;post&#39;</span><span class="p">)</span>
    
    <span class="c1"># Plot posterior mean</span>
    <span class="n">R_mean_expanded</span> <span class="o">=</span> <span class="n">expand_R_intervals</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">R_mean</span><span class="p">),</span> <span class="n">T</span><span class="p">,</span> <span class="n">interval_days</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">T</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">R_mean_expanded</span><span class="p">),</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Posterior Mean&#39;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c1"># Just plot MAP</span>
    <span class="n">map_R_expanded</span> <span class="o">=</span> <span class="n">expand_R_intervals</span><span class="p">(</span><span class="n">map_R</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">interval_days</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">T</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">map_R_expanded</span><span class="p">),</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;MAP Estimate&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;R(t)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Estimated vs True Time-Varying Reproduction Number&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">month_days</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">months</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Deaths comparison</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">T</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">observed_deaths</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Observed Deaths&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">T</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">map_daily_deaths</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Model Prediction&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Days&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Daily Deaths&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Model Fit to Death Data&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">month_days</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">months</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/8f51453ce0ec58a81d0757fe20295aaba3aef46fbbea2d0a33bdb635dfc8fda1.png" src="../_images/8f51453ce0ec58a81d0757fe20295aaba3aef46fbbea2d0a33bdb635dfc8fda1.png" />
</div>
</div>
</section>
<section id="summary">
<h2>7. Summary<a class="headerlink" href="#summary" title="Link to this heading">#</a></h2>
<p>In this notebook, we demonstrated:</p>
<ol class="arabic simple">
<li><p><strong>Setting up a realistic SAFIR model</strong> with UK demographics and contact patterns</p></li>
<li><p><strong>Simulating a UK 2020-like epidemic</strong> with time-varying R(t) capturing:</p>
<ul class="simple">
<li><p>Initial exponential growth (March)</p></li>
<li><p>First lockdown impact (April-June)</p></li>
<li><p>Summer reopening (July-September)</p></li>
<li><p>Second lockdown (October-November)</p></li>
<li><p>Alpha variant emergence (December)</p></li>
</ul>
</li>
<li><p><strong>Bayesian inference</strong> for estimating R(t) from death data using <strong>emidm</strong>â€™s differentiable SAFIR model:</p>
<ul class="simple">
<li><p>Piecewise constant parameterization (2-week intervals)</p></li>
<li><p>Random walk prior for smoothness</p></li>
<li><p>Poisson likelihood for death counts</p></li>
<li><p>MAP estimation via gradient descent</p></li>
<li><p>Full posterior via NUTS (if BlackJAX available)</p></li>
</ul>
</li>
</ol>
<section id="key-insights">
<h3>Key Insights<a class="headerlink" href="#key-insights" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>Differentiable models enable gradient-based inference</strong> - Much faster than derivative-free methods</p></li>
<li><p><strong>End-to-end differentiability</strong> - Gradients flow through the entire SAFIR simulation</p></li>
<li><p><strong>JIT compilation</strong> - Using <code class="docutils literal notranslate"><span class="pre">&#64;jax.jit</span></code> on the log-posterior makes inference much faster</p></li>
<li><p><strong>Death data has a lag</strong> - R(t) changes are reflected in deaths ~2-3 weeks later</p></li>
<li><p><strong>Uncertainty quantification</strong> - Bayesian approach provides credible intervals</p></li>
</ul>
</section>
<section id="extensions">
<h3>Extensions<a class="headerlink" href="#extensions" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Use a Gaussian Process prior for smoother R(t) estimates</p></li>
<li><p>Incorporate multiple data streams (cases, hospitalizations, deaths)</p></li>
<li><p>Add observation model for reporting delays and noise</p></li>
<li><p>Estimate other parameters (IFR, hospitalization rates) jointly</p></li>
</ul>
</section>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="bayesian_inference.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Bayesian Inference with Differentiable Models</p>
      </div>
    </a>
    <a class="right-next"
       href="surrogate.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Training Surrogates</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setup-and-installation">1. Setup and Installation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#uk-demographics-and-contact-matrix">2. UK Demographics and Contact Matrix</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#simulating-the-uk-2020-epidemic">3. Simulating the UK 2020 Epidemic</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#bayesian-inference-setup">4. Bayesian Inference Setup</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#model-structure">Model Structure</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#maximum-a-posteriori-map-estimation">5. Maximum A Posteriori (MAP) Estimation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#full-bayesian-inference-with-mcmc">6. Full Bayesian Inference with MCMC</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#summary">7. Summary</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#key-insights">Key Insights</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#extensions">Extensions</a></li>
</ul>
</li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/notebooks/safir_inference.ipynb.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.2.3.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>