name: PR Docs Preview

"on":
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  preview:
    # Only run for PRs from branches within the same repo (fork PRs won't have token perms to deploy)
    if: ${{ github.event.pull_request.head.repo.full_name == github.repository }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    concurrency:
      group: pr-preview-${{ github.event.pull_request.number }}
      cancel-in-progress: true

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install package (docs)
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[docs]"

      - name: Build Sphinx HTML
        run: |
          sphinx-build -W -b html docs docs/_build/html

      - name: Set up Quarto
        uses: quarto-dev/quarto-actions/setup@v2

      - name: Render Quarto slides
        run: |
          quarto render slides/emidm_intro1.qmd --no-execute

      - name: Copy Quarto slides into Sphinx site
        run: |
          mkdir -p docs/_build/html/slides

          cp -r _site/slides/emidm_intro1.html docs/_build/html/slides/
          if [ -d _site/slides/emidm_intro1_files ]; then cp -r _site/slides/emidm_intro1_files docs/_build/html/slides/; fi

          if [ -d _site/site_libs ]; then cp -r _site/site_libs docs/_build/html/; fi
          if [ -f _site/styles.css ]; then cp -r _site/styles.css docs/_build/html/; fi

      - name: Deploy preview to gh-pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages
          folder: docs/_build/html
          target-folder: previews/pr-${{ github.event.pull_request.number }}
          clean: true

      - name: Comment preview link
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            Docs preview for this PR:
            https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/previews/pr-${{ github.event.pull_request.number }}/
